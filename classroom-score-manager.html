<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾å ‚åŠ åˆ†ç®¡ç†ç³»ç»Ÿ</title>
    <!-- Supabase å®¢æˆ·ç«¯åº“ -->
    <!-- Supabase å®¢æˆ·ç«¯åº“ - ä½¿ç”¨å…·ä½“ç‰ˆæœ¬å· -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨æ ·å¼ */
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select,
        input[type="text"],
        input[type="number"],
        button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* ç»Ÿè®¡ä¿¡æ¯æ ·å¼ */
        .stats {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: normal;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-card .detail {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #dee2e6;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* åŠ å‡åˆ†æŒ‰é’®æ ·å¼ */
        .score-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
        }

        .score-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            font-size: 16px;
            line-height: 1;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .score-btn.plus {
            background: #28a745;
        }

        .score-btn.plus:hover {
            background: #218838;
        }

        .score-btn.minus {
            background: #dc3545;
        }

        .score-btn.minus:hover {
            background: #c82333;
        }

        /* ç»„åˆ«æ ‡ç­¾æ ·å¼ */
        .group-tag {
            display: inline-block;
            padding: 4px 10px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* åˆ†æ•°çŠ¶æ€æ ·å¼ */
        .score-value.high {
            color: #28a745;
        }

        .score-value.medium {
            color: #ffc107;
        }

        .score-value.low {
            color: #dc3545;
        }

        .score-value.negative {
            color: #dc3545;
            font-weight: bold;
        }

        /* å¿«é€ŸåŠ åˆ†æ¨¡å¼ */
        .quick-mode {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2196F3;
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .quick-mode:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .quick-mode.active {
            background: #f44336;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select {
            width: 100%;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
                justify-content: space-between;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 600px;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        /* æ‰“å°æ ·å¼ */
        @media print {

            .controls,
            .quick-mode,
            .score-btn {
                display: none !important;
            }

            body {
                background: white;
            }

            .container {
                max-width: 100%;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes scoreChange {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .score-value.changing {
            animation: scoreChange 0.3s ease;
        }

        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            display: none;
            z-index: 2000;
        }

        .toast.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* åŒæ­¥æŒ‰é’®æ ·å¼ */
        .btn-sync {
            background-color: #4CAF50;
            color: white;
        }

        .btn-sync:hover {
            background-color: #45a049;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- å¤´éƒ¨æ§åˆ¶åŒº -->
        <div class="header">
            <h1>è¯¾å ‚åŠ åˆ†ç®¡ç†ç³»ç»Ÿ</h1>
            <p style="color: #666; font-size: 14px; margin-top: -10px;">æ”¯æŒExcelå¯¼å…¥å¯¼å‡º Â· æ•°æ®è‡ªåŠ¨ä¿å­˜</p>
            <div class="controls">
                <div class="control-group">
                    <label>ç­çº§ï¼š</label>
                    <select id="classSelect" onchange="switchClass()">
                        <option value="class1">è®¡ç®—æœº2401ç­</option>
                        <option value="class2">è®¡ç®—æœº2402ç­</option>
                        <option value="class3">è®¡ç®—æœº2403ç­</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>ç­›é€‰ç»„åˆ«ï¼š</label>
                    <select id="groupFilter" onchange="filterTable()">
                        <option value="">å…¨éƒ¨ç»„åˆ«</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>æœç´¢ï¼š</label>
                    <input type="text" id="searchInput" placeholder="å§“åæˆ–å­¦å·" onkeyup="filterTable()">
                </div>

                <div class="control-group">
                    <label>åŠ åˆ†å€¼ï¼š</label>
                    <input type="number" id="scoreStep" value="1" min="0.5" max="10" step="0.5" style="width: 80px;">
                </div>

                <button onclick="showAddStudentModal()">æ·»åŠ å­¦ç”Ÿ</button>
                <button onclick="showExportMenu()" class="btn-secondary">å¯¼å‡ºæ•°æ®</button>
                <button onclick="showImportInfo()" class="btn-secondary">å¯¼å…¥æ•°æ®</button>
                <button onclick="printReport()" class="btn-secondary">æ‰“å°</button>
            </div>
            <div class="action-buttons">
                <button id="exportBtn" class="btn">å¯¼å‡ºExcel</button>
                <button id="importBtn" class="btn">å¯¼å…¥Excel</button>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                <button id="syncBtn" class="btn btn-sync">åŒæ­¥åˆ°äº‘ç«¯</button>
                <button id="checkSyncBtn" class="btn btn-secondary">æ£€æŸ¥åŒæ­¥çŠ¶æ€</button>
                <button id="resetBtn" class="btn btn-danger">é‡ç½®åˆ†æ•°</button>
                <button id="saveBtn" class="btn btn-primary">ä¿å­˜æ•°æ®</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯åŒº -->
        <div class="stats" id="statsContainer">
            <!-- ç»Ÿè®¡ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- è¡¨æ ¼åŒºåŸŸ -->
        <div class="table-container">
            <table id="scoreTable">
                <thead>
                    <tr>
                        <th style="width: 50px;">åºå·</th>
                        <th style="width: 120px;">å­¦å·</th>
                        <th style="width: 100px;">å§“å</th>
                        <th style="width: 150px;">å¹³æ—¶æ€»åˆ†<br><small>(50åˆ†æ»¡)</small></th>
                        <th style="width: 150px;">å°ç»„æ´»åŠ¨<br><small>(30åˆ†æ»¡)</small></th>
                        <th style="width: 150px;">è¯¾å ‚è¡¨ç°<br><small>(20åˆ†æ»¡)</small></th>
                        <th style="width: 100px;">ç»„åˆ«</th>
                        <th style="width: 80px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- å¿«é€ŸåŠ åˆ†æ¨¡å¼æŒ‰é’® -->
    <div class="quick-mode" onclick="toggleQuickMode()">
        <span id="quickModeText">å¿«é€ŸåŠ åˆ†æ¨¡å¼</span>
    </div>

    <!-- æ·»åŠ å­¦ç”Ÿæ¨¡æ€æ¡† -->
    <div class="modal" id="addStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ·»åŠ å­¦ç”Ÿ</h2>
            </div>
            <div class="form-group">
                <label>å­¦å·ï¼š</label>
                <input type="text" id="newStudentId" placeholder="è¯·è¾“å…¥å­¦å·">
            </div>
            <div class="form-group">
                <label>å§“åï¼š</label>
                <input type="text" id="newStudentName" placeholder="è¯·è¾“å…¥å§“å">
            </div>
            <div class="form-group">
                <label>ç»„åˆ«ï¼š</label>
                <select id="newStudentGroup">
                    <option value="">è¯·é€‰æ‹©ç»„åˆ«</option>
                </select>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('addStudentModal')" class="btn-secondary">å–æ¶ˆ</button>
                <button onclick="addStudent()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºé€‰é¡¹æ¨¡æ€æ¡† -->
    <div class="modal" id="exportModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>é€‰æ‹©å¯¼å‡ºæ ¼å¼</h2>
            </div>
            <div style="display: grid; gap: 15px;">
                <button onclick="exportToExcel()" style="padding: 15px; font-size: 16px; background: #28a745;">
                    ğŸ“Š å¯¼å‡ºä¸º Excel (CSVæ ¼å¼)
                </button>
                <button onclick="exportToJSON()" style="padding: 15px; font-size: 16px; background: #6c757d;">
                    ğŸ“„ å¯¼å‡ºä¸º JSON (å¤‡ä»½æ ¼å¼)
                </button>
                <button onclick="exportCurrentClassExcel()"
                    style="padding: 15px; font-size: 16px; background: #17a2b8;">
                    ğŸ“‹ ä»…å¯¼å‡ºå½“å‰ç­çº§ (Excel)
                </button>
            </div>
            <div class="modal-footer" style="margin-top: 20px;">
                <button onclick="closeModal('exportModal')" class="btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥é€‰é¡¹æ¨¡æ€æ¡† -->
    <div class="modal" id="importModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2>å¯¼å…¥æ•°æ®</h2>
            </div>
            <div style="margin-bottom: 20px; color: #666; line-height: 1.6;">
                <p><strong>æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼š</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>Excel/CSVæ–‡ä»¶ï¼š</strong>ä»æœ¬ç³»ç»Ÿå¯¼å‡ºçš„CSVæ–‡ä»¶ï¼Œæˆ–æŒ‰ç›¸åŒæ ¼å¼æ•´ç†çš„Excelæ–‡ä»¶ï¼ˆå¦å­˜ä¸ºCSVï¼‰</li>
                    <li><strong>JSONæ–‡ä»¶ï¼š</strong>ç³»ç»Ÿå¤‡ä»½æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰ç­çº§çš„å®Œæ•´æ•°æ®</li>
                </ul>
                <p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; color: #856404;">
                    âš ï¸ å¯¼å…¥CSVæ—¶ï¼Œæ•°æ®å°†æ›´æ–°åˆ°å½“å‰é€‰ä¸­çš„ç­çº§
                </p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('importModal')" class="btn-secondary">å–æ¶ˆ</button>
                <button onclick="importData()" style="background: #17a2b8;">é€‰æ‹©æ–‡ä»¶</button>
            </div>
        </div>
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <div class="toast" id="toast"></div>

    <!-- å¯¼å…¥æ–‡ä»¶inputï¼ˆéšè—ï¼‰ -->
    <input type="file" id="importFile" style="display: none;" accept=".json,.csv" onchange="handleImport(event)">

    <script>
        // å…¨å±€å˜é‡
        let currentClass = 'class1';
        let quickMode = false;
        let students = {};
        let supabaseClient = null;
        
        // åˆå§‹åŒ–ç­çº§æ•°æ®ç»“æ„
        const classData = {
            class1: [],
            class2: [],
            class3: []
        };

        // Supabase é…ç½®
        const SUPABASE_URL = 'https://tgbafseosjbxqdnudgtl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnYmFmc2Vvc2pieHFkbnVkZ3RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1Nzg3NjYsImV4cCI6MjA2NDE1NDc2Nn0.T-znHPx4xR_wGXejgvFBd_wGRSu1ECsVJ8KkLJbgIwU';

        // ç­‰å¾… Supabase SDK åŠ è½½çš„å‡½æ•°
        function waitForSupabase() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (window.supabase && typeof window.supabase.createClient === 'function') {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);

                // 10ç§’è¶…æ—¶
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                }, 10000);
            });
        }

        // ç­‰å¾… Supabase SDK åŠ è½½
        function waitForSupabase() {
            return new Promise((resolve, reject) => {
                // å¦‚æœå·²ç»åŠ è½½ï¼Œç›´æ¥è¿”å›
                if (window.supabase && typeof window.supabase.createClient === 'function') {
                    resolve();
                    return;
                }

                // è®¾ç½®æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆ10ç§’ï¼‰
                const maxWaitTime = 10000;
                const startTime = Date.now();

                // å®šæœŸæ£€æŸ¥æ˜¯å¦åŠ è½½å®Œæˆ
                const checkInterval = setInterval(() => {
                    if (window.supabase && typeof window.supabase.createClient === 'function') {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (Date.now() - startTime > maxWaitTime) {
                        clearInterval(checkInterval);
                        reject(new Error('Supabase SDK åŠ è½½è¶…æ—¶'));
                    }
                }, 200);
            });
        }

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        async function initSupabase() {
            try {
                // ç­‰å¾… SDK åŠ è½½
                await waitForSupabase();

                if (window.supabase && typeof window.supabase.createClient === 'function') {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('Supabase åˆå§‹åŒ–æˆåŠŸ');
                    return true;
                } else {
                    throw new Error('Supabase SDK æœªæ­£ç¡®åŠ è½½');
                }
            } catch (error) {
                console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', error);
                showToast('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨', 'error');
                return false;
            }
        }

        // æ·»åŠ ä¿å­˜æ•°æ®å‡½æ•°
        async function saveData(skipSync = false) {
            try {
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const localData = {
                    students: students,
                    currentClass: currentClass,
                    quickMode: quickMode,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('classroomScores_backup', JSON.stringify(localData));
                console.log('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');

                // å¦‚æœè®¾ç½®ä¸ºè·³è¿‡åŒæ­¥ï¼Œåªä¿å­˜åˆ°æœ¬åœ°
                if (skipSync) {
                    showToast('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°', 'success');
                    return;
                }

                // å¦‚æœ Supabase å¯ç”¨ï¼ŒåŒæ­¥åˆ°æ•°æ®åº“
                if (supabaseClient && students[currentClass]) {
                    try {
                        const upsertData = [];
                        for (const student of students[currentClass]) {
                            upsertData.push({
                                class_id: currentClass,
                                student_id: student.id,
                                name: student.name,
                                daily_score: student.daily || 0,
                                group_score: student.group || 0,
                                performance_score: student.performance || 0,
                                team_name: student.team || 'æœªåˆ†ç»„'
                            });
                        }

                        if (upsertData.length > 0) {
                            console.log('å°è¯•åŒæ­¥', upsertData.length, 'æ¡æ•°æ®åˆ°æ•°æ®åº“');
                            
                            // é¦–å…ˆæµ‹è¯•è¿æ¥
                            const testResult = await supabaseClient
                                .from('class_scores')
                                .select('count(*)', { count: 'exact' })
                                .limit(1);
                            
                            if (testResult.error) {
                                throw new Error('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ' + testResult.error.message);
                            }

                            // æ‰§è¡ŒåŒæ­¥
                            const { error } = await supabaseClient
                                .from('class_scores')
                                .upsert(upsertData, {
                                    onConflict: 'class_id, student_id',
                                    returning: 'minimal'
                                });

                            if (error) {
                                // æ£€æŸ¥æ˜¯å¦æ˜¯ RLS é”™è¯¯
                                if (error.message && error.message.includes('policy')) {
                                    throw new Error('æ•°æ®åº“è¡Œçº§å®‰å…¨ç­–ç•¥(RLS)é™åˆ¶ï¼Œè¯·ä½¿ç”¨åŒæ­¥åˆ°äº‘ç«¯æŒ‰é’®');
                                }
                                throw error;
                            }

                            // æ›´æ–°åŒæ­¥çŠ¶æ€
                            localStorage.setItem('lastSyncTime', new Date().toISOString());
                            showToast('æ•°æ®å·²ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯', 'success');
                            console.log('åŒæ­¥æˆåŠŸ:', upsertData.length, 'æ¡æ•°æ®');
                        } else {
                            showToast('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆæ— æ•°æ®éœ€è¦åŒæ­¥ï¼‰', 'success');
                        }
                    } catch (syncError) {
                        console.error('åŒæ­¥åˆ°æ•°æ®åº“å¤±è´¥:', syncError);
                        showToast('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†åŒæ­¥å¤±è´¥: ' + syncError.message, 'warning');
                        // è®°å½•åŒæ­¥çŠ¶æ€
                        localStorage.setItem('syncFailed', 'true');
                        localStorage.setItem('syncErrorMessage', syncError.message);
                    }
                } else {
                    if (!supabaseClient) {
                        console.log('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œåªä¿å­˜åˆ°æœ¬åœ°');
                    }
                    showToast('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°', 'success');
                }
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                
                // å°è¯•ç´§æ€¥å¤‡ä»½
                try {
                    const emergencyBackup = JSON.stringify(students);
                    localStorage.setItem('classroomScores_emergency', emergencyBackup);
                    console.log('å·²åˆ›å»ºç´§æ€¥å¤‡ä»½');
                } catch (backupError) {
                    console.error('åˆ›å»ºç´§æ€¥å¤‡ä»½å¤±è´¥:', backupError);
                }
            }
        }

        // åŠ è½½æ•°æ®å‡½æ•°
        async function loadData() {
            try {
                // ä¼˜å…ˆä» Supabase åŠ è½½
                if (supabaseClient) {
                    showToast('æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®...', 'info');
                    const { data, error } = await supabaseClient
                        .from('class_scores')
                        .select('*')
                        .eq('class_id', currentClass);

                    if (error) {
                        console.error('ä»æ•°æ®åº“åŠ è½½æ•°æ®å¤±è´¥:', error);
                        throw error;
                    }

                    if (data && data.length > 0) {
                        // å°†æ•°æ®åº“æ•°æ®è½¬æ¢ä¸ºåº”ç”¨æ ¼å¼
                        const formattedData = data.map(item => ({
                            id: item.student_id,
                            name: item.name,
                            daily: item.daily_score,
                            group: item.group_score,
                            performance: item.performance_score,
                            team: item.team_name
                        }));
                        
                        students[currentClass] = formattedData;
                        console.log('ä» Supabase åŠ è½½äº†', formattedData.length, 'æ¡æ•°æ®');
                        showToast(`ä»äº‘ç«¯æˆåŠŸåŠ è½½ ${formattedData.length} æ¡æ•°æ®`, 'success');
                        return;
                    } else {
                        console.log('äº‘ç«¯æ²¡æœ‰ç­çº§', currentClass, 'çš„æ•°æ®');
                    }
                } else {
                    console.log('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•ä»äº‘ç«¯åŠ è½½');
                }

                // å¦‚æœäº‘ç«¯æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                const localData = localStorage.getItem('classroomScores_backup');
                if (localData) {
                    const parsedData = JSON.parse(localData);
                    if (parsedData.students && parsedData.students[currentClass] && parsedData.students[currentClass].length > 0) {
                        students[currentClass] = parsedData.students[currentClass];
                        console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½äº†', students[currentClass].length, 'æ¡æ•°æ®');
                        showToast(`ä»æœ¬åœ°å­˜å‚¨åŠ è½½äº† ${students[currentClass].length} æ¡æ•°æ®`, 'info');
                        
                        // å¦‚æœæœ‰æœ¬åœ°æ•°æ®ä½†äº‘ç«¯æ²¡æœ‰ï¼Œå°è¯•åŒæ­¥åˆ°äº‘ç«¯
                        if (supabaseClient) {
                            try {
                                showToast('æ­£åœ¨å°è¯•åŒæ­¥æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯...', 'info');
                                await syncToDatabase();
                            } catch (syncError) {
                                console.error('åŒæ­¥å¤±è´¥:', syncError);
                                showToast('åŒæ­¥åˆ°äº‘ç«¯å¤±è´¥: ' + syncError.message, 'warning');
                            }
                        }
                        return;
                    }
                }

                // å¦‚æœæ²¡æœ‰äº‘ç«¯å’Œæœ¬åœ°æ•°æ®ï¼Œåˆ›å»ºç©ºæ•°æ®é›†
                students[currentClass] = [];
                console.log('åˆ›å»ºäº†ç©ºæ•°æ®é›†ï¼Œè¯·å¯¼å…¥è¡¨æ ¼');
                showToast('è¯·ç‚¹å‡»â€œå¯¼å…¥Excelâ€æŒ‰é’®ä¸Šä¼ ç­çº§æ•°æ®', 'info');
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showToast('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
                
                // å‡ºé”™æ—¶åˆ›å»ºç©ºæ•°æ®é›†
                students[currentClass] = [];
                showToast('åˆ›å»ºäº†ç©ºç­çº§ï¼Œè¯·å¯¼å…¥æ•°æ®', 'warning');
            }
        }

        // æ·»åŠ åˆ‡æ¢ç­çº§å‡½æ•°
        async function switchClass() {
            const select = document.getElementById('classSelect');
            currentClass = select.value;
            await loadData();
            renderTable();
            updateStats();
            updateGroupFilter();
        }

        // ä» Excel å¯¼å…¥æ•°æ®
        async function importFromExcel(file) {
            try {
                showToast('æ­£åœ¨å¤„ç† Excel æ–‡ä»¶...', 'info');
                console.log('å¼€å§‹å¯¼å…¥ Excel æ–‡ä»¶:', file.name);
                
                const reader = new FileReader();

                reader.onload = async function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        console.log('æ–‡ä»¶å¤§å°:', data.length, 'å­—èŠ‚');
                        
                        const workbook = XLSX.read(data, { type: 'array' });
                        console.log('å·¥ä½œè¡¨æ•°é‡:', workbook.SheetNames.length);

                        // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        console.log('ä½¿ç”¨å·¥ä½œè¡¨:', firstSheetName);

                        // å°†å·¥ä½œè¡¨è½¬æ¢ä¸º JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        console.log('è¯»å–åˆ°', jsonData.length, 'è¡Œæ•°æ®');

                        if (jsonData.length < 2) {
                            throw new Error('Excel æ–‡ä»¶ä¸åŒ…å«æœ‰æ•ˆæ•°æ®');
                        }

                        // è·å–åˆ—æ ‡é¢˜
                        const headers = jsonData[0];
                        console.log('è¯»å–åˆ°åˆ—æ ‡é¢˜:', headers);

                        // æ£€æŸ¥å¿…è¦çš„åˆ—
                        const requiredColumns = ['å­¦å·', 'å§“å', 'å¹³æ—¶åˆ†', 'å°ç»„åˆ†', 'è¯¾å ‚åˆ†', 'ç»„åˆ«'];
                        const columnIndices = {};

                        for (const col of requiredColumns) {
                            const index = headers.findIndex(h => h === col);
                            if (index === -1) {
                                console.error('ç¼ºå°‘å¿…è¦åˆ—:', col);
                                console.log('å®é™…åˆ—æ ‡é¢˜:', headers);
                                throw new Error(`ç¼ºå°‘å¿…è¦çš„åˆ—: ${col}`);
                            }
                            columnIndices[col] = index;
                            console.log(`æ‰¾åˆ°åˆ— '${col}' åœ¨ç´¢å¼• ${index}`);
                        }

                        // å¤„ç†æ•°æ®è¡Œ
                        const importedStudents = [];
                        const skippedRows = [];
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length <= Math.max(...Object.values(columnIndices))) {
                                skippedRows.push(i + 1); // Excel è¡Œå·ä» 1 å¼€å§‹
                                continue; // è·³è¿‡ä¸å®Œæ•´çš„è¡Œ
                            }

                            const studentId = String(row[columnIndices['å­¦å·']]);
                            if (!studentId) {
                                skippedRows.push(i + 1);
                                continue; // è·³è¿‡æ²¡æœ‰å­¦å·çš„è¡Œ
                            }

                            // å¤„ç†æ•°å€¼åˆ—ï¼Œç¡®ä¿æ˜¯æœ‰æ•ˆæ•°å­—
                            let daily = 0, group = 0, performance = 0;
                            
                            try {
                                daily = parseFloat(row[columnIndices['å¹³æ—¶åˆ†']]);
                                if (isNaN(daily)) daily = 0;
                            } catch (e) { daily = 0; }
                            
                            try {
                                group = parseFloat(row[columnIndices['å°ç»„åˆ†']]);
                                if (isNaN(group)) group = 0;
                            } catch (e) { group = 0; }
                            
                            try {
                                performance = parseFloat(row[columnIndices['è¯¾å ‚åˆ†']]);
                                if (isNaN(performance)) performance = 0;
                            } catch (e) { performance = 0; }

                            const student = {
                                id: studentId,
                                name: row[columnIndices['å§“å']] || '',
                                daily: daily,
                                group: group,
                                performance: performance,
                                team: row[columnIndices['ç»„åˆ«']] || 'æœªåˆ†ç»„'
                            };

                            importedStudents.push(student);
                        }

                        if (importedStudents.length === 0) {
                            throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å­¦ç”Ÿæ•°æ®');
                        }

                        console.log('æˆåŠŸå¯¼å…¥', importedStudents.length, 'æ¡å­¦ç”Ÿæ•°æ®');
                        if (skippedRows.length > 0) {
                            console.log('è·³è¿‡äº†', skippedRows.length, 'è¡Œæ— æ•ˆæ•°æ®ï¼Œè¡Œå·:', skippedRows);
                        }

                        // æ›´æ–°å½“å‰ç­çº§çš„å­¦ç”Ÿæ•°æ®
                        students[currentClass] = importedStudents;

                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œå…ˆè·³è¿‡è‡ªåŠ¨åŒæ­¥
                        await saveData(true);
                        
                        // é‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œç»Ÿè®¡ä¿¡æ¯
                        renderTable();
                        updateStats();
                        updateGroupFilter();

                        showToast(`æˆåŠŸå¯¼å…¥ ${importedStudents.length} æ¡å­¦ç”Ÿæ•°æ®`, 'success');
                        
                        // å°è¯•åŒæ­¥åˆ°æ•°æ®åº“
                        try {
                            if (supabaseClient) {
                                showToast('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...', 'info');
                                await syncToDatabase();
                            } else {
                                showToast('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†æœªåŒæ­¥åˆ°äº‘ç«¯ï¼ˆæ•°æ®åº“æœªè¿æ¥ï¼‰', 'warning');
                            }
                        } catch (syncError) {
                            console.error('å¯¼å…¥ååŒæ­¥å¤±è´¥:', syncError);
                            showToast('æ•°æ®å·²å¯¼å…¥å¹¶ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†åŒæ­¥å¤±è´¥: ' + syncError.message, 'warning');
                        }
                    } catch (error) {
                        console.error('Excel æ•°æ®å¤„ç†é”™è¯¯:', error);
                        showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
                    }
                };

                reader.onerror = function () {
                    console.error('è¯»å–æ–‡ä»¶å¤±è´¥');
                    showToast('è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
                };

                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é‡ç½®åˆ†æ•°å‡½æ•°
        async function resetScores() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å­¦ç”Ÿçš„åˆ†æ•°å—ï¼Ÿè¿™å°†æŠŠå¹³æ—¶åˆ†ã€å°ç»„åˆ†å’Œè¯¾å ‚åˆ†éƒ½è®¾ä¸º0ã€‚')) {
                return;
            }

            try {
                if (students[currentClass] && students[currentClass].length > 0) {
                    for (const student of students[currentClass]) {
                        student.daily = 0;
                        student.group = 0;
                        student.performance = 0;
                    }

                    // ä¿å­˜åˆ°æ•°æ®åº“å’Œæœ¬åœ°å­˜å‚¨
                    await saveData();

                    // é‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œç»Ÿè®¡ä¿¡æ¯
                    renderTable();
                    updateStats();

                    showToast('æ‰€æœ‰å­¦ç”Ÿåˆ†æ•°å·²é‡ç½®ä¸º0', 'success');
                } else {
                    showToast('å½“å‰ç­çº§æ²¡æœ‰å­¦ç”Ÿæ•°æ®', 'warning');
                }
            } catch (error) {
                console.error('é‡ç½®åˆ†æ•°å¤±è´¥:', error);
                showToast('é‡ç½®åˆ†æ•°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å‡ºæ•°æ®åˆ°Excel
        function exportToExcel() {
            try {
                if (!students[currentClass] || students[currentClass].length === 0) {
                    showToast('å½“å‰ç­çº§æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'warning');
                    return;
                }

                // å‡†å¤‡å¯¼å‡ºæ•°æ®
                const exportData = students[currentClass].map(student => ({
                    'å­¦å·': student.id,
                    'å§“å': student.name,
                    'å¹³æ—¶åˆ†': student.daily || 0,
                    'å°ç»„åˆ†': student.group || 0,
                    'è¯¾å ‚åˆ†': student.performance || 0,
                    'æ€»åˆ†': (student.daily || 0) + (student.group || 0) + (student.performance || 0),
                    'ç»„åˆ«': student.team || 'æœªåˆ†ç»„'
                }));

                // åˆ›å»ºworkbookå’Œworksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);

                // æ·»åŠ worksheetåˆ°workbook
                XLSX.utils.book_append_sheet(wb, ws, currentClass);

                // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
                const filename = `ç­çº§æˆç»©_${currentClass}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, filename);

                showToast(`æˆåŠŸå¯¼å‡º ${exportData.length} æ¡å­¦ç”Ÿæ•°æ®`, 'success');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showToast('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŒæ­¥æ•°æ®åˆ°äº‘ç«¯
        async function syncToDatabase() {
            try {
                if (!supabaseClient) {
                    // å°è¯•é‡æ–°åˆå§‹åŒ– Supabase
                    const initialized = await initSupabase();
                    if (!initialized) {
                        throw new Error('Supabase æœªåˆå§‹åŒ–ï¼Œæ— æ³•åŒæ­¥');
                    }
                }

                if (!students[currentClass] || students[currentClass].length === 0) {
                    showToast('å½“å‰ç­çº§æ²¡æœ‰æ•°æ®å¯åŒæ­¥', 'warning');
                    return;
                }

                showToast('æ­£åœ¨åŒæ­¥æ•°æ®...', 'info');

                // å‡†å¤‡è¦åŒæ­¥çš„æ•°æ®
                const upsertData = [];
                for (const student of students[currentClass]) {
                    upsertData.push({
                        class_id: currentClass,
                        student_id: student.id,
                        name: student.name,
                        daily_score: student.daily || 0,
                        group_score: student.group || 0,
                        performance_score: student.performance || 0,
                        team_name: student.team || 'æœªåˆ†ç»„'
                    });
                }

                // æµ‹è¯•è¿æ¥
                const testResult = await supabaseClient
                    .from('class_scores')
                    .select('count(*)', { count: 'exact' })
                    .limit(1);

                if (testResult.error) {
                    console.error('æµ‹è¯•æ•°æ®åº“è¿æ¥å¤±è´¥:', testResult.error);
                    throw new Error('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ' + testResult.error.message);
                }

                console.log('æµ‹è¯•è¿æ¥æˆåŠŸï¼Œå¼€å§‹åŒæ­¥æ•°æ®...');

                // æ‰§è¡ŒåŒæ­¥
                const { data, error } = await supabaseClient
                    .from('class_scores')
                    .upsert(upsertData, {
                        onConflict: 'class_id, student_id',
                        returning: 'minimal'
                    });

                if (error) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ RLS é”™è¯¯
                    if (error.message && error.message.includes('policy')) {
                        throw new Error('æ•°æ®åº“è¡Œçº§å®‰å…¨ç­–ç•¥(RLS)é™åˆ¶ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ç¦ç”¨ RLS');
                    }
                    throw error;
                }

                // æ›´æ–°åŒæ­¥çŠ¶æ€
                localStorage.setItem('lastSyncTime', new Date().toISOString());
                showToast(`æˆåŠŸåŒæ­¥ ${upsertData.length} æ¡æ•°æ®åˆ°äº‘ç«¯`, 'success');
                console.log('åŒæ­¥æˆåŠŸ:', upsertData.length, 'æ¡æ•°æ®');
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                showToast('åŒæ­¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥åŒæ­¥çŠ¶æ€
        async function checkSyncStatus() {
            try {
                if (!supabaseClient) {
                    showToast('Supabase æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ£€æŸ¥åŒæ­¥çŠ¶æ€', 'warning');
                    return;
                }

                // è·å–ä¸Šæ¬¡åŒæ­¥æ—¶é—´
                const lastSyncTime = localStorage.getItem('lastSyncTime');
                if (!lastSyncTime) {
                    showToast('æ•°æ®ä»æœªåŒæ­¥åˆ°äº‘ç«¯', 'warning');
                    return;
                }

                // æ£€æŸ¥æ•°æ®åº“è¿æ¥
                const { data, error, count } = await supabaseClient
                    .from('class_scores')
                    .select('count(*)', { count: 'exact' })
                    .eq('class_id', currentClass);

                if (error) {
                    throw new Error('æ— æ³•è¿æ¥åˆ°æ•°æ®åº“: ' + error.message);
                }

                // æ£€æŸ¥æœ¬åœ°å’Œäº‘ç«¯æ•°æ®æ•°é‡
                const localCount = students[currentClass] ? students[currentClass].length : 0;
                const dbCount = count || 0;

                const lastSyncDate = new Date(lastSyncTime);
                const formattedDate = lastSyncDate.toLocaleString();

                if (localCount === dbCount) {
                    showToast(`æ•°æ®å·²åŒæ­¥ã€‚ä¸Šæ¬¡åŒæ­¥: ${formattedDate}`, 'success');
                } else {
                    showToast(`æ•°æ®ä¸åŒæ­¥ã€‚æœ¬åœ°: ${localCount} æ¡ï¼Œäº‘ç«¯: ${dbCount} æ¡`, 'warning');
                }

                console.log('åŒæ­¥çŠ¶æ€:', {
                    lastSync: formattedDate,
                    localCount,
                    dbCount
                });
            } catch (error) {
                console.error('æ£€æŸ¥åŒæ­¥çŠ¶æ€å¤±è´¥:', error);
                showToast('æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testDatabaseConnection() {
            try {
                if (!supabaseClient) {
                    await initSupabase();
                    if (!supabaseClient) {
                        throw new Error('Supabase åˆå§‹åŒ–å¤±è´¥');
                    }
                }

                console.log('æµ‹è¯•æ•°æ®åº“è¿æ¥...');

                // æµ‹è¯•è¯»å–
                const readTest = await supabaseClient
                    .from('class_scores')
                    .select('*')
                    .limit(1);

                console.log('è¯»å–æµ‹è¯•:', readTest);

                // æµ‹è¯•å†™å…¥
                const writeTest = await supabaseClient
                    .from('class_scores')
                    .upsert({
                        class_id: 'test',
                        student_id: 'test123',
                        name: 'æµ‹è¯•å­¦ç”Ÿ',
                        daily_score: 10,
                        group_score: 10,
                        performance_score: 10,
                        team_name: 'æµ‹è¯•ç»„'
                    });

                console.log('å†™å…¥æµ‹è¯•:', writeTest);

                if (readTest.error || writeTest.error) {
                    throw new Error(readTest.error ? readTest.error.message : writeTest.error.message);
                }

                showToast('æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                return true;
            } catch (error) {
                console.error('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                showToast('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        async function initApp() {
            try {
                // åˆå§‹åŒ– Supabase
                const supabaseInitialized = await initSupabase();
                console.log('Supabase åˆå§‹åŒ–çŠ¶æ€:', supabaseInitialized);

                // åŠ è½½æ•°æ®
                await loadData();

                // æ¸²æŸ“è¡¨æ ¼å’Œç»Ÿè®¡ä¿¡æ¯
                renderTable();
                updateStats();
                updateGroupFilter();

                // ç»‘å®šäº‹ä»¶å¤„ç†ç¨‹åº
                document.getElementById('classSelect').addEventListener('change', switchClass);
                document.getElementById('importBtn').addEventListener('click', () => document.getElementById('fileInput').click());
                document.getElementById('fileInput').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        importFromExcel(e.target.files[0]);
                        e.target.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
                    }
                });
                document.getElementById('exportBtn').addEventListener('click', exportToExcel);
                document.getElementById('resetBtn').addEventListener('click', resetScores);
                document.getElementById('saveBtn').addEventListener('click', saveData);
                document.getElementById('syncBtn').addEventListener('click', syncToDatabase);
                document.getElementById('checkSyncBtn').addEventListener('click', checkSyncStatus);
                document.getElementById('groupFilter').addEventListener('change', filterByGroup);

                // è®¾ç½®å®šæ—¶è‡ªåŠ¨ä¿å­˜
                setInterval(saveData, 300000); // æ¯5åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜

                console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                showToast('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
        window.addEventListener('DOMContentLoaded', initApp);

        // åˆå§‹åŒ–ç­çº§æ•°æ®ç»“æ„
        const classData = {
            class1: [],
            class2: [],
            class3: []
        };

        // åˆå§‹åŒ–
        async function init() {
            try {
                // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
                initSupabase();

                await loadData();
                setupRealtimeUpdates();
                updateGroupFilter();
                renderTable();
                updateStats();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showToast('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');

                // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
                loadFromLocalStorage();
                renderTable();
                updateStats();
                updateGroupFilter();
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('classroomScores_backup');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.students && data.students[currentClass]) {
                        students[currentClass] = data.students[currentClass];
                    } else if (data.students) {
                        students = data.students || {};
                    } else {
                        students[currentClass] = [];
                    }
                    currentClass = data.currentClass || currentClass;
                    quickMode = data.quickMode || false;

                    document.getElementById('classSelect').value = currentClass;
                    showToast('å·²åŠ è½½æœ¬åœ°å¤‡ä»½æ•°æ®', 'warning');
                } else {
                    students[currentClass] = [];
                    showToast('æ— æœ¬åœ°å¤‡ä»½ã€‚ä½¿ç”¨é»˜è®¤æ•°æ®ã€‚', 'warning');
                }
            } catch (e) {
                console.error('åŠ è½½æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
                students[currentClass] = [];
            }
        }

        // è®¾ç½®å®æ—¶æ›´æ–°
        function setupRealtimeUpdates() {
            // æ£€æŸ¥ Supabase å®¢æˆ·ç«¯æ˜¯å¦å¯ç”¨
            if (!supabaseClient) {
                console.warn('æ— æ³•è®¾ç½®å®æ—¶æ›´æ–°ï¼šSupabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                return;
            }

            try {
                // è®¢é˜…class_scoresè¡¨çš„å˜æ›´
                const subscription = supabaseClient
                    .channel('class_scores_changes')
                    .on('postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'class_scores'
                        },
                        async (payload) => {
                            console.log('æ•°æ®åº“å˜æ›´:', payload);
                            // é‡æ–°åŠ è½½æ•°æ®ä»¥è·å–æœ€æ–°çŠ¶æ€
                            await loadData();
                            renderTable();
                            updateStats();
                            updateGroupFilter();
                        }
                    )
                    .subscribe();

                // åœ¨é¡µé¢å¸è½½æ—¶å–æ¶ˆè®¢é˜…
                window.addEventListener('beforeunload', () => {
                    if (supabaseClient) {
                        supabaseClient.removeChannel(subscription);
                    }
                });
            } catch (error) {
                console.error('è®¾ç½®å®æ—¶æ›´æ–°å¤±è´¥:', error);
            }
        }

        // ä»SupabaseåŠ è½½æ•°æ®
        async function loadData() {
            try {
                showToast('æ­£åœ¨åŠ è½½æ•°æ®...');

                // æ£€æŸ¥ Supabase å®¢æˆ·ç«¯æ˜¯å¦å¯ç”¨
                if (!supabaseClient) {
                    throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                }

                // ä»Supabaseè·å–æ•°æ®
                const { data: dbData, error } = await supabaseClient
                    .from('class_scores')
                    .select('*')
                    .eq('class_id', currentClass);

                if (error) throw error; // If there's a DB error, throw it to the catch block

                // Initialize/clear data for the current class
                students[currentClass] = [];

                if (dbData && dbData.length > 0) {
                    dbData.forEach(item => {
                        students[currentClass].push({
                            id: item.student_id,
                            name: item.name, // Corrected
                            daily: item.daily_score || 0,
                            group: item.group_score || 0,
                            performance: item.performance_score || 0,
                            team: item.team_name || 'æœªåˆ†ç»„' // Corrected
                        });
                    });
                    showToast('æ•°æ®åŠ è½½æˆåŠŸ');
                } else {
                    // No data for this specific class in the database
                    showToast(`ç­çº§ ${currentClass} å°šæ— å­¦ç”Ÿæ•°æ®ï¼Œå¯å°è¯•ä»Excelå¯¼å…¥ã€‚`, 'info');
                    // students[currentClass] is already an empty array
                }

                // Update UI elements
                document.getElementById('classSelect').value = currentClass;

                // Ensure UI is updated after data load/processing
                renderTable();
                updateStats();
                updateGroupFilter();

            } catch (error) { // This catch block handles DB errors or other errors in the try block
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showToast('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');

                // ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä½œä¸ºåå¤‡æ–¹æ¡ˆ
                loadFromLocalStorage();
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;

            const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const groupFilter = document.getElementById('groupFilter')?.value || '';

            const classData = students[currentClass] || [];
            let filteredData = [...classData];

            // åº”ç”¨ç­›é€‰
            if (searchTerm) {
                filteredData = filteredData.filter(s =>
                    s.name.toLowerCase().includes(searchTerm) ||
                    s.id.includes(searchTerm)
                );
            }

            if (groupFilter) {
                filteredData = filteredData.filter(s => s.team === groupFilter);
            }

            tbody.innerHTML = filteredData.map((student, index) => {
                const dailyClass = getScoreClass(student.daily, 50);
                const groupClass = getScoreClass(student.group, 30);
                const perfClass = getScoreClass(student.performance, 20);

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>
                            <div class="score-cell">
                                <button class="score-btn minus" onclick="updateScore('${student.id}', 'daily', -1)">-</button>
                                <span class="score-value ${dailyClass}" id="daily-${student.id}">${student.daily}</span>
                                <button class="score-btn plus" onclick="updateScore('${student.id}', 'daily', 1)">+</button>
                            </div>
                        </td>
                        <td>
                            <div class="score-cell">
                                <button class="score-btn minus" onclick="updateScore('${student.id}', 'group', -1)">-</button>
                                <span class="score-value ${groupClass}" id="group-${student.id}">${student.group}</span>
                                <button class="score-btn plus" onclick="updateScore('${student.id}', 'group', 1)">+</button>
                            </div>
                        </td>
                        <td>
                            <div class="score-cell">
                                <button class="score-btn minus" onclick="updateScore('${student.id}', 'performance', -1)">-</button>
                                <span class="score-value ${perfClass}" id="performance-${student.id}">${student.performance}</span>
                                <button class="score-btn plus" onclick="updateScore('${student.id}', 'performance', 1)">+</button>
                            </div>
                        </td>
                        <td><span class="group-tag">${student.team}</span></td>
                        <td>
                            <button onclick="deleteStudent('${student.id}')" class="btn-danger" style="padding: 5px 10px; font-size: 12px;">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><h3>æš‚æ— æ•°æ®</h3><p>è¯·æ·»åŠ å­¦ç”Ÿæˆ–åˆ‡æ¢ç­çº§</p></td></tr>';
            }
        }

        // è·å–åˆ†æ•°æ ·å¼ç±»
        function getScoreClass(score, max) {
            if (score < 0) return 'negative';
            const ratio = score / max;
            if (ratio >= 0.8) return 'high';
            if (ratio >= 0.6) return 'medium';
            return 'low';
        }

        // æ›´æ–°åˆ†æ•°
        async function updateScore(studentId, type, delta) {
            const step = parseFloat(document.getElementById('scoreStep').value) || 1;
            const actualDelta = delta * step;

            const classData = students[currentClass];
            const student = classData.find(s => s.id === studentId);

            if (student) {
                // æ›´æ–°æœ¬åœ°æ•°æ®
                student[type] = Math.round((student[type] + actualDelta) * 10) / 10;

                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                const element = document.getElementById(`${type}-${studentId}`);
                element.classList.add('changing');
                setTimeout(() => element.classList.remove('changing'), 300);

                // ç›´æ¥æ›´æ–°åˆ°æ•°æ®åº“
                try {
                    // æ£€æŸ¥ Supabase å®¢æˆ·ç«¯æ˜¯å¦å¯ç”¨
                    if (!supabaseClient) {
                        throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                    }

                    const updatePayload = {
                        class_id: currentClass,
                        student_id: studentId,
                        name: student.name, // Corrected field name
                        daily_score: student.daily || 0,
                        group_score: student.group || 0,
                        performance_score: student.performance || 0,
                        team_name: student.team || 'æœªåˆ†ç»„' // Corrected field name
                        // updated_at will be handled by the database trigger
                    };

                    const { data, error } = await supabaseClient
                        .from('class_scores')
                        .upsert(updatePayload, {
                            onConflict: 'class_id, student_id' // Ensure conflict target is a string for Supabase JS v2+
                        });

                    if (error) {
                        // If upsert fails, consider reverting local changes or notifying user more clearly
                        // For now, we'll log the error and show a toast
                        console.error('ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥:', error);
                        showToast('åˆ†æ•°æ›´æ–°åŒæ­¥å¤±è´¥: ' + error.message, 'error');
                        // Potentially revert local student[type] change here if strict consistency is needed
                        // student[type] = Math.round((student[type] - actualDelta) * 10) / 10; // Revert
                        // renderTable(); // Re-render to show reverted score
                        // updateStats();
                        return; // Stop further processing for this update if DB save failed
                    }

                    // If DB update is successful, update local backup
                    const localData = {
                        students: students, // students object already reflects the new score
                        currentClass: currentClass,
                        quickMode: quickMode,
                        lastSaved: new Date().toISOString()
                    };
                    localStorage.setItem('classroomScores_backup', JSON.stringify(localData));
                    showToast('åˆ†æ•°å·²åŒæ­¥', 'success'); // Confirmation for successful DB sync

                } catch (error) { // Catch any other unexpected errors during the try block
                    console.error('æ›´æ–°åˆ†æ•°æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯:', error);
                    showToast('æ›´æ–°åˆ†æ•°æ—¶å‡ºé”™: ' + error.message, 'error');
                }

                renderTable();
                updateStats();

                if (quickMode) {
                    showToast(`${student.name} ${type === 'daily' ? 'å¹³æ—¶åˆ†' : type === 'group' ? 'å°ç»„åˆ†' : 'è¯¾å ‚åˆ†'} ${actualDelta > 0 ? '+' : ''}${actualDelta}`);
                }
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const data = students[currentClass] || [];
            const container = document.getElementById('statsContainer');

            if (data.length === 0) {
                container.innerHTML = '<div class="stat-card"><h3>æš‚æ— æ•°æ®</h3></div>';
                return;
            }

            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const stats = {
                total: data.length,
                dailyAvg: (data.reduce((sum, s) => sum + s.daily, 0) / data.length).toFixed(1),
                groupAvg: (data.reduce((sum, s) => sum + s.group, 0) / data.length).toFixed(1),
                perfAvg: (data.reduce((sum, s) => sum + s.performance, 0) / data.length).toFixed(1),
                noGroup: data.filter(s => s.group === 0).length,
                noPerf: data.filter(s => s.performance === 0).length,
                negative: data.filter(s => s.daily < 0 || s.performance < 0).length
            };

            container.innerHTML = `
                <div class="stat-card">
                    <h3>å­¦ç”Ÿæ€»æ•°</h3>
                    <div class="value">${stats.total}</div>
                    <div class="detail">å½“å‰ç­çº§å­¦ç”Ÿäººæ•°</div>
                </div>
                <div class="stat-card">
                    <h3>å¹³æ—¶æ€»åˆ†</h3>
                    <div class="value">${stats.dailyAvg}</div>
                    <div class="detail">å¹³å‡åˆ† (æ»¡åˆ†50)</div>
                </div>
                <div class="stat-card">
                    <h3>å°ç»„æ´»åŠ¨</h3>
                    <div class="value">${stats.groupAvg}</div>
                    <div class="detail">å¹³å‡åˆ† (æ»¡åˆ†30) Â· æœªå‚ä¸: ${stats.noGroup}äºº</div>
                </div>
                <div class="stat-card">
                    <h3>è¯¾å ‚è¡¨ç°</h3>
                    <div class="value">${stats.perfAvg}</div>
                    <div class="detail">å¹³å‡åˆ† (æ»¡åˆ†20) Â· æœªåŠ åˆ†: ${stats.noPerf}äºº</div>
                </div>
            `;
        }

        // æ›´æ–°ç»„åˆ«ç­›é€‰å™¨
        function updateGroupFilter() {
            const data = students[currentClass] || [];
            const groups = [...new Set(data.map(s => s.team))].sort();
            const select = document.getElementById('groupFilter');

            select.innerHTML = '<option value="">å…¨éƒ¨ç»„åˆ«</option>' +
                groups.map(g => `<option value="${g}">${g}</option>`).join('');
        }

        // ç­›é€‰è¡¨æ ¼
        function filterTable() {
            renderTable();
        }

        // å¿«é€ŸåŠ åˆ†æ¨¡å¼
        function toggleQuickMode() {
            quickMode = !quickMode;
            const btn = document.querySelector('.quick-mode');
            const text = document.getElementById('quickModeText');

            if (quickMode) {
                btn.classList.add('active');
                text.textContent = 'é€€å‡ºå¿«é€Ÿæ¨¡å¼';
                showToast('å¿«é€ŸåŠ åˆ†æ¨¡å¼å·²å¼€å¯');
            } else {
                btn.classList.remove('active');
                text.textContent = 'å¿«é€ŸåŠ åˆ†æ¨¡å¼';
                showToast('å¿«é€ŸåŠ åˆ†æ¨¡å¼å·²å…³é—­');
            }
        }

        // æ˜¾ç¤ºæ·»åŠ å­¦ç”Ÿæ¨¡æ€æ¡†
        function showAddStudentModal() {
            const modal = document.getElementById('addStudentModal');
            modal.classList.add('show');

            // æ›´æ–°ç»„åˆ«é€‰é¡¹
            const data = students[currentClass] || [];
            const groups = [...new Set(data.map(s => s.team))].sort();
            const select = document.getElementById('newStudentGroup');

            select.innerHTML = '<option value="">è¯·é€‰æ‹©ç»„åˆ«</option>' +
                groups.map(g => `<option value="${g}">${g}</option>`).join('') +
                '<option value="new">æ–°å»ºç»„åˆ«...</option>';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // æ·»åŠ å­¦ç”Ÿ
        async function addStudent() {
            const id = document.getElementById('newStudentId').value.trim();
            const name = document.getElementById('newStudentName').value.trim();
            let group = document.getElementById('newStudentGroup').value;

            if (!id || !name) {
                showToast('è¯·å¡«å†™å­¦å·å’Œå§“å');
                return;
            }

            if (group === 'new') {
                group = prompt('è¯·è¾“å…¥æ–°ç»„åˆ«åç§°ï¼š');
                if (!group) return;
            }

            if (!students[currentClass]) {
                students[currentClass] = [];
            }

            // æ£€æŸ¥å­¦å·æ˜¯å¦å·²å­˜åœ¨
            if (students[currentClass].find(s => s.id === id)) {
                showToast('è¯¥å­¦å·å·²å­˜åœ¨');
                return;
            }

            const newStudentData = {
                class_id: currentClass,
                student_id: id,
                name: name,
                daily_score: 0,
                group_score: 0,
                performance_score: 0,
                team_name: group || 'æœªåˆ†ç»„'
            };

            try {
                // æ£€æŸ¥ Supabase å®¢æˆ·ç«¯æ˜¯å¦å¯ç”¨
                if (!supabaseClient) {
                    throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                }

                showToast('æ­£åœ¨æ·»åŠ å­¦ç”Ÿ...', 'info');
                const { data, error } = await supabaseClient
                    .from('class_scores')
                    .insert([newStudentData])
                    .select(); // select() is optional here, but can be useful to get the inserted row back

                if (error) {
                    // Check for unique constraint violation (duplicate student_id for the class_id)
                    if (error.code === '23505') { // PostgreSQL unique violation error code
                        showToast('é”™è¯¯ï¼šè¯¥å­¦å·å·²å­˜åœ¨äºå½“å‰ç­çº§ã€‚', 'error');
                    } else {
                        throw error;
                    }
                    return; // Stop execution if there was an error
                }

                // If insert was successful, then update the local students array
                if (data && data.length > 0) {
                    students[currentClass].push({
                        id: data[0].student_id,
                        name: data[0].name,
                        daily: data[0].daily_score,
                        group: data[0].group_score,
                        performance: data[0].performance_score,
                        team: data[0].team_name || 'æœªåˆ†ç»„'
                    });
                    showToast('å­¦ç”Ÿæ·»åŠ æˆåŠŸ', 'success');
                } else {
                    // Fallback if data is not returned, though with .select() it should be
                    // Or handle cases where insert might not return data as expected
                    students[currentClass].push({
                        id: id, name: name, daily: 0, group: 0, performance: 0, team: group || 'æœªåˆ†ç»„'
                    });
                    showToast('å­¦ç”Ÿå·²æ·»åŠ åˆ°æœ¬åœ°ï¼Œä½†åŒæ­¥ç¡®è®¤å¤±è´¥ã€‚è¯·åˆ·æ–°æŸ¥çœ‹ã€‚', 'warning');
                }

            } catch (error) {
                console.error('æ·»åŠ å­¦ç”Ÿå¤±è´¥:', error);
                showToast('æ·»åŠ å­¦ç”Ÿå¤±è´¥: ' + error.message, 'error');
                return; // Stop execution if there was an error
            }

            renderTable();
            updateStats();
            updateGroupFilter();
            closeModal('addStudentModal');
            showToast('å­¦ç”Ÿæ·»åŠ æˆåŠŸ');

            // æ¸…ç©ºè¡¨å•
            document.getElementById('newStudentId').value = '';
            document.getElementById('newStudentName').value = '';
            document.getElementById('newStudentGroup').value = '';
        }

        // åˆ é™¤å­¦ç”Ÿ
        async function deleteStudent(studentId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥å­¦ç”Ÿå—ï¼Ÿ')) {
                try {
                    // æ£€æŸ¥ Supabase å®¢æˆ·ç«¯æ˜¯å¦å¯ç”¨
                    if (!supabaseClient) {
                        throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                    }

                    showToast('æ­£åœ¨åˆ é™¤å­¦ç”Ÿ...', 'info');
                    const { data, error } = await supabaseClient
                        .from('class_scores')
                        .delete()
                        .eq('class_id', currentClass)
                        .eq('student_id', studentId);

                    if (error) throw error;

                    // å¦‚æœæ•°æ®åº“åˆ é™¤æˆåŠŸï¼Œåˆ™æ›´æ–°æœ¬åœ°æ•°æ®
                    const index = students[currentClass].findIndex(s => s.id === studentId);
                    if (index > -1) {
                        students[currentClass].splice(index, 1);
                    } else {
                        // This case should ideally not happen if UI is in sync with local data
                        console.warn('å­¦ç”Ÿå·²ä»æ•°æ®åº“åˆ é™¤ï¼Œä½†åœ¨æœ¬åœ°æœªæ‰¾åˆ°ï¼Œå¯èƒ½æ•°æ®å·²ä¸åŒæ­¥ã€‚');
                    }
                    showToast('å­¦ç”Ÿå·²åˆ é™¤', 'success');

                } catch (error) {
                    console.error('åˆ é™¤å­¦ç”Ÿå¤±è´¥:', error);
                    showToast('åˆ é™¤å­¦ç”Ÿå¤±è´¥: ' + error.message, 'error');
                    return; // Stop execution if there was an error
                }

                renderTable();
                updateStats();
            }
        }

        // æ˜¾ç¤ºå¯¼å‡ºèœå•
        function showExportMenu() {
            document.getElementById('exportModal').classList.add('show');
        }

        // å¯¼å‡ºä¸ºExcel (CSVæ ¼å¼)
        function exportToExcel() {
            // å‡†å¤‡CSVå†…å®¹
            let csv = '\ufeff'; // UTF-8 BOMï¼Œç¡®ä¿Excelæ­£ç¡®è¯†åˆ«ä¸­æ–‡

            // æ·»åŠ æ ‡é¢˜
            csv += `è¯¾å ‚åˆ†æ•°ç»Ÿè®¡è¡¨ - å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}\n\n`;

            // éå†æ‰€æœ‰ç­çº§
            for (const [className, classData] of Object.entries(students)) {
                if (classData.length === 0) continue;

                // ç­çº§æ ‡é¢˜
                const classLabel = className === 'class1' ? 'è®¡ç®—æœº2401ç­' :
                    className === 'class2' ? 'è®¡ç®—æœº2402ç­' : 'è®¡ç®—æœº2403ç­';
                csv += `\n${classLabel}\n`;

                // è¡¨å¤´
                csv += 'åºå·,å­¦å·,å§“å,å¹³æ—¶æ€»åˆ†(50æ»¡),å°ç»„æ´»åŠ¨(30æ»¡),è¯¾å ‚è¡¨ç°(20æ»¡),æ€»åˆ†,ç»„åˆ«\n';

                // æ•°æ®è¡Œ
                classData.forEach((student, index) => {
                    const total = student.daily + student.group + student.performance;
                    csv += `${index + 1},${student.id},${student.name},${student.daily},${student.group},${student.performance},${total},${student.team}\n`;
                });

                // ç»Ÿè®¡ä¿¡æ¯
                const stats = calculateClassStats(classData);
                csv += `\nç»Ÿè®¡ä¿¡æ¯ï¼š\n`;
                csv += `å­¦ç”Ÿæ€»æ•°,${stats.total}\n`;
                csv += `å¹³æ—¶åˆ†å¹³å‡,${stats.dailyAvg}\n`;
                csv += `å°ç»„åˆ†å¹³å‡,${stats.groupAvg}\n`;
                csv += `è¯¾å ‚åˆ†å¹³å‡,${stats.perfAvg}\n`;
                csv += `æ€»åˆ†å¹³å‡,${stats.totalAvg}\n`;
                csv += `æœªå‚ä¸å°ç»„æ´»åŠ¨,${stats.noGroup}äºº\n`;
                csv += `æœªå‚ä¸è¯¾å ‚,${stats.noPerf}äºº\n`;
                csv += `\n`;
            }

            // ä¸‹è½½æ–‡ä»¶
            downloadFile(csv, `è¯¾å ‚åˆ†æ•°_${new Date().toISOString().slice(0, 10)}.csv`, 'text/csv;charset=utf-8');
            closeModal('exportModal');
            showToast('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸ');
        }

        // ä»…å¯¼å‡ºå½“å‰ç­çº§Excel
        function exportCurrentClassExcel() {
            const classData = students[currentClass] || [];
            if (classData.length === 0) {
                showToast('å½“å‰ç­çº§æ²¡æœ‰æ•°æ®');
                return;
            }

            let csv = '\ufeff'; // UTF-8 BOM

            // ç­çº§æ ‡é¢˜
            const classLabel = currentClass === 'class1' ? 'è®¡ç®—æœº2401ç­' :
                currentClass === 'class2' ? 'è®¡ç®—æœº2402ç­' : 'è®¡ç®—æœº2403ç­';
            csv += `${classLabel} - è¯¾å ‚åˆ†æ•°ç»Ÿè®¡è¡¨\n`;
            csv += `å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}\n\n`;

            // è¡¨å¤´
            csv += 'åºå·,å­¦å·,å§“å,å¹³æ—¶æ€»åˆ†(50æ»¡),å°ç»„æ´»åŠ¨(30æ»¡),è¯¾å ‚è¡¨ç°(20æ»¡),æ€»åˆ†,ç»„åˆ«\n';

            // æŒ‰ç»„åˆ«æ’åº
            const sortedData = [...classData].sort((a, b) => {
                if (a.team === b.team) {
                    return a.id.localeCompare(b.id);
                }
                return a.team.localeCompare(b.team);
            });

            // æ•°æ®è¡Œ
            sortedData.forEach((student, index) => {
                const total = student.daily + student.group + student.performance;
                csv += `${index + 1},${student.id},${student.name},${student.daily},${student.group},${student.performance},${total},${student.team}\n`;
            });

            // ç»Ÿè®¡ä¿¡æ¯
            const stats = calculateClassStats(classData);
            csv += `\n\nç»Ÿè®¡ä¿¡æ¯\n`;
            csv += `é¡¹ç›®,æ•°å€¼\n`;
            csv += `å­¦ç”Ÿæ€»æ•°,${stats.total}äºº\n`;
            csv += `å¹³æ—¶åˆ†å¹³å‡,${stats.dailyAvg}åˆ†\n`;
            csv += `å°ç»„åˆ†å¹³å‡,${stats.groupAvg}åˆ†\n`;
            csv += `è¯¾å ‚åˆ†å¹³å‡,${stats.perfAvg}åˆ†\n`;
            csv += `æ€»åˆ†å¹³å‡,${stats.totalAvg}åˆ†\n`;
            csv += `æœ€é«˜æ€»åˆ†,${stats.maxTotal}åˆ†\n`;
            csv += `æœ€ä½æ€»åˆ†,${stats.minTotal}åˆ†\n`;
            csv += `æœªå‚ä¸å°ç»„æ´»åŠ¨,${stats.noGroup}äºº\n`;
            csv += `æœªå‚ä¸è¯¾å ‚,${stats.noPerf}äºº\n`;

            // å„ç»„ç»Ÿè®¡
            csv += `\n\nå„ç»„ç»Ÿè®¡\n`;
            csv += `ç»„åˆ«,äººæ•°,å¹³å‡æ€»åˆ†\n`;
            const groupStats = calculateGroupStats(classData);
            for (const [group, stat] of Object.entries(groupStats)) {
                csv += `${group},${stat.count}äºº,${stat.avg}åˆ†\n`;
            }

            // ä¸‹è½½æ–‡ä»¶
            downloadFile(csv, `${classLabel}_åˆ†æ•°ç»Ÿè®¡_${new Date().toISOString().slice(0, 10)}.csv`, 'text/csv;charset=utf-8');
            closeModal('exportModal');
            showToast('å½“å‰ç­çº§Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸ');
        }

        // å¯¼å‡ºä¸ºJSON (åŸåŠŸèƒ½)
        function exportToJSON() {
            const dataStr = JSON.stringify(students, null, 2);
            downloadFile(dataStr, `è¯¾å ‚åˆ†æ•°_å¤‡ä»½_${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
            closeModal('exportModal');
            showToast('JSONå¤‡ä»½æ–‡ä»¶å¯¼å‡ºæˆåŠŸ');
        }

        // é€šç”¨ä¸‹è½½æ–‡ä»¶å‡½æ•°
        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        // è®¡ç®—ç­çº§ç»Ÿè®¡æ•°æ®
        function calculateClassStats(classData) {
            const totals = classData.map(s => s.daily + s.group + s.performance);
            return {
                total: classData.length,
                dailyAvg: (classData.reduce((sum, s) => sum + s.daily, 0) / classData.length).toFixed(1),
                groupAvg: (classData.reduce((sum, s) => sum + s.group, 0) / classData.length).toFixed(1),
                perfAvg: (classData.reduce((sum, s) => sum + s.performance, 0) / classData.length).toFixed(1),
                totalAvg: (totals.reduce((sum, t) => sum + t, 0) / totals.length).toFixed(1),
                maxTotal: Math.max(...totals).toFixed(1),
                minTotal: Math.min(...totals).toFixed(1),
                noGroup: classData.filter(s => s.group === 0).length,
                noPerf: classData.filter(s => s.performance === 0).length
            };
        }

        // è®¡ç®—å„ç»„ç»Ÿè®¡æ•°æ®
        function calculateGroupStats(classData) {
            const groups = {};
            classData.forEach(student => {
                if (!groups[student.team]) {
                    groups[student.team] = { count: 0, total: 0 };
                }
                groups[student.team].count++;
                groups[student.team].total += student.daily + student.group + student.performance;
            });

            const result = {};
            for (const [group, data] of Object.entries(groups)) {
                result[group] = {
                    count: data.count,
                    avg: (data.total / data.count).toFixed(1)
                };
            }
            return result;
        }

        // å¯¼å‡ºæ•°æ® (å·²åºŸå¼ƒï¼Œä¿ç•™å…¼å®¹æ€§)
        function exportData() {
            showExportMenu();
        }

        // æ˜¾ç¤ºå¯¼å…¥ä¿¡æ¯
        function showImportInfo() {
            document.getElementById('importModal').classList.add('show');
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            closeModal('importModal');
            document.getElementById('importFile').click();
        }

        // å¤„ç†å¯¼å…¥
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const fileName = file.name.toLowerCase();

            reader.onload = function (e) {
                try {
                    if (fileName.endsWith('.json')) {
                        // JSONæ ¼å¼å¯¼å…¥
                        const imported = JSON.parse(e.target.result);
                        students = imported;
                        saveData();
                        renderTable();
                        updateStats();
                        updateGroupFilter();
                        showToast('JSONæ•°æ®å¯¼å…¥æˆåŠŸ');
                    } else if (fileName.endsWith('.csv')) {
                        // CSVæ ¼å¼å¯¼å…¥
                        importFromCSV(e.target.result);
                    } else {
                        showToast('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
                    }
                } catch (error) {
                    showToast('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
                    console.error(error);
                }
            };
            reader.onerror = function () {
                showToast('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è¯»å–é”™è¯¯');
            };
            reader.readAsText(file, 'UTF-8');

            // æ¸…ç©ºinput
            event.target.value = '';
        }

        // ä»CSVå¯¼å…¥æ•°æ®
        function importFromCSV(csvContent) {
            try {
                // ç§»é™¤BOMæ ‡è®°
                csvContent = csvContent.replace(/^\ufeff/, '');

                // æŒ‰è¡Œåˆ†å‰²
                const lines = csvContent.split('\n').filter(line => line.trim());

                // æŸ¥æ‰¾è¡¨å¤´è¡Œ
                let headerIndex = -1;
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('åºå·') && lines[i].includes('å­¦å·') && lines[i].includes('å§“å')) {
                        headerIndex = i;
                        break;
                    }
                }

                if (headerIndex === -1) {
                    showToast('CSVæ ¼å¼é”™è¯¯ï¼šæœªæ‰¾åˆ°è¡¨å¤´');
                    return;
                }

                // æ¸…ç©ºå½“å‰ç­çº§æ•°æ®
                if (!students[currentClass]) {
                    students[currentClass] = [];
                }

                // è§£ææ•°æ®è¡Œ
                let importCount = 0;
                for (let i = headerIndex + 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line || line.includes('ç»Ÿè®¡ä¿¡æ¯') || line.includes('å„ç»„ç»Ÿè®¡')) break;

                    const values = line.split(',');
                    if (values.length >= 8) {
                        const studentId = values[1].trim();

                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                        const existingIndex = students[currentClass].findIndex(s => s.id === studentId);
                        const studentData = {
                            id: studentId,
                            name: values[2].trim(),
                            daily: parseFloat(values[3]) || 0,
                            group: parseFloat(values[4]) || 0,
                            performance: parseFloat(values[5]) || 0,
                            team: values[7].trim() || 'æœªåˆ†ç»„'
                        };

                        if (existingIndex >= 0) {
                            // æ›´æ–°ç°æœ‰å­¦ç”Ÿ
                            students[currentClass][existingIndex] = studentData;
                        } else {
                            // æ·»åŠ æ–°å­¦ç”Ÿ
                            students[currentClass].push(studentData);
                        }
                        importCount++;
                    }
                }

                saveData();
                renderTable();
                updateStats();
                updateGroupFilter();
                showToast(`æˆåŠŸå¯¼å…¥ ${importCount} æ¡æ•°æ®`);

            } catch (error) {
                showToast('CSVå¯¼å…¥å¤±è´¥');
                console.error(error);
            }
        }

        // å¯¼å…¥Excelæ–‡ä»¶
        async function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                showToast('æ­£åœ¨å¯¼å…¥Excelæ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');

                // è¯»å–Excelæ–‡ä»¶
                const data = await readExcelFile(file);

                // å¤„ç†å¯¼å…¥çš„æ•°æ®
                const allRecordsToUpsert = [];
                let totalImportedCount = 0;
                let importedClassIds = [];

                for (const sheetName in data) {
                    if (data.hasOwnProperty(sheetName)) {
                        const classId = sheetName;
                        const sheetData = data[sheetName];
                        importedClassIds.push(classId);

                        sheetData.forEach(row => {
                            // å‡è®¾Excelä¸­çš„åˆ—åä¸ºï¼šå­¦å·, å§“å, å¹³æ—¶åˆ†, å°ç»„åˆ†, è¯¾å ‚åˆ†, ç»„åˆ«
                            // è¯·æ ¹æ®å®é™…Excelåˆ—åè°ƒæ•´è¿™é‡Œçš„row.FieldName
                            const studentId = row.å­¦å· ? row.å­¦å·.toString().trim() : null;
                            const studentName = row.å§“å ? row.å§“å.toString().trim() : null;

                            if (studentId && studentName) {
                                allRecordsToUpsert.push({
                                    class_id: classId,
                                    student_id: studentId,
                                    name: studentName,
                                    daily_score: parseFloat(row.å¹³æ—¶åˆ†) || 0,
                                    group_score: parseFloat(row.å°ç»„åˆ†) || 0,
                                    performance_score: parseFloat(row.è¯¾å ‚åˆ†) || 0,
                                    team_name: row.ç»„åˆ« ? row.ç»„åˆ«.toString().trim() : 'æœªåˆ†ç»„'
                                });
                                totalImportedCount++;
                            }
                        });
                    }
                }

                if (allRecordsToUpsert.length > 0) {
                    // æ£€æŸ¥ Supabase å®¢æˆ·ç«¯æ˜¯å¦å¯ç”¨
                    if (!supabaseClient) {
                        throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                    }

                    showToast(`å…±æ‰¾åˆ° ${totalImportedCount} æ¡è®°å½•ï¼Œè·¨è¶Š ${importedClassIds.length} ä¸ªç­çº§ã€‚æ­£åœ¨ä¸Šä¼ åˆ°æ•°æ®åº“...`, 'info');
                    const { data: upsertData, error: upsertError } = await supabaseClient
                        .from('class_scores')
                        .upsert(allRecordsToUpsert, {
                            onConflict: 'class_id, student_id',
                            ignoreDuplicates: false // Ensure existing records are updated
                        });

                    if (upsertError) {
                        console.error('æ•°æ®åº“æ‰¹é‡å¯¼å…¥/æ›´æ–°å¤±è´¥:', upsertError);
                        showToast('æ•°æ®ä¸Šä¼ å¤±è´¥: ' + upsertError.message, 'error');
                        return;
                    }

                    showToast(`æˆåŠŸå¯¼å…¥/æ›´æ–° ${totalImportedCount} æ¡å­¦ç”Ÿè®°å½•åˆ°æ•°æ®åº“ï¼`, 'success');

                    // æ›´æ–°ç­çº§é€‰æ‹©å™¨ï¼Œæ·»åŠ æ–°å¯¼å…¥çš„ç­çº§
                    const classSelect = document.getElementById('classSelect');
                    const existingOptions = Array.from(classSelect.options).map(opt => opt.value);

                    // æ·»åŠ æ–°å¯¼å…¥çš„ç­çº§åˆ°é€‰æ‹©å™¨
                    importedClassIds.forEach(classId => {
                        if (!existingOptions.includes(classId)) {
                            const option = document.createElement('option');
                            option.value = classId;
                            option.textContent = classId; // å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´æ˜¾ç¤ºåç§°
                            classSelect.appendChild(option);
                        }
                    });

                    // å¯¼å…¥æˆåŠŸåçš„æ•°æ®åŠ è½½å¤„ç†
                    if (importedClassIds.includes(currentClass)) {
                        // å¦‚æœå½“å‰ç­çº§åœ¨å¯¼å…¥çš„ç­çº§ä¸­ï¼Œé‡æ–°åŠ è½½å½“å‰ç­çº§æ•°æ®
                        await loadData();
                        showToast('å½“å‰ç­çº§æ•°æ®å·²æ›´æ–°ã€‚', 'info');
                    } else if (importedClassIds.length > 0) {
                        // è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦åˆ‡æ¢åˆ°æ–°å¯¼å…¥çš„ç­çº§
                        if (confirm(`æ˜¯å¦åˆ‡æ¢åˆ°æ–°å¯¼å…¥çš„ç­çº§ï¼Ÿ${importedClassIds[0]}`)) {
                            currentClass = importedClassIds[0];
                            classSelect.value = currentClass;
                            await loadData();
                        } else {
                            showToast('å…¶ä»–ç­çº§æ•°æ®å·²å¯¼å…¥ï¼Œå¯ä»¥ä»ç­çº§é€‰æ‹©å™¨ä¸­é€‰æ‹©æŸ¥çœ‹ã€‚', 'info');
                        }
                    }
                    // renderTable(); // loadDataä¼šè°ƒç”¨
                    // updateGroupFilter(); // loadDataä¼šè°ƒç”¨
                    // updateStats(); // loadDataä¼šè°ƒç”¨

                } else {
                    showToast('æœªåœ¨Excelæ–‡ä»¶ä¸­æ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼Œæˆ–æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·æ£€æŸ¥Excelåˆ—åæ˜¯å¦ä¸ºï¼šå­¦å·, å§“å, å¹³æ—¶åˆ†, å°ç»„åˆ†, è¯¾å ‚åˆ†, ç»„åˆ«', 'warning');
                }

            } catch (error) {
                console.error('å¯¼å…¥Excelå¤±è´¥:', error);
                showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                // é‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
                event.target.value = '';
            }
        }

        // è¯»å–Excelæ–‡ä»¶
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const allSheetsData = {};
                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null }); // raw:false ensures dates are parsed, defval handles empty cells
                            allSheetsData[sheetName] = jsonData;
                        });
                        resolve(allSheetsData);
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = function () {
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                };

                reader.readAsArrayBuffer(file);
            });
        }


        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            try {
                const localData = {
                    students: students,
                    currentClass: currentClass,
                    quickMode: quickMode,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('classroomScores', JSON.stringify(localData));
            } catch (e) {
                console.error('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
            }
        }

        // æ‰“å°æŠ¥å‘Š
        function printReport() {
            window.print();
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            if (type === 'error') {
                toast.style.background = '#dc3545';
                toast.style.color = 'white';
            } else if (type === 'success') {
                toast.style.background = '#28a745';
                toast.style.color = 'white';
            } else {
                toast.style.background = '#333';
                toast.style.color = 'white';
            }

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // Ctrl+S ä¿å­˜
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveData();
                showToast('æ•°æ®å·²ä¿å­˜');
            }

            // Ctrl+E å¯¼å‡º
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                showExportMenu();
            }

            // Ctrl+I å¯¼å…¥
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                showImportInfo();
            }

            // Ctrl+F æœç´¢
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }

            // Escape å…³é—­æ¨¡æ€æ¡†
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => modal.classList.remove('show'));
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        // æ·»åŠ å¸®åŠ©æç¤º
        console.log('è¯¾å ‚åŠ åˆ†ç®¡ç†ç³»ç»Ÿ - ä½¿ç”¨è¯´æ˜ï¼š');
        console.log('- ç‚¹å‡» +/- æŒ‰é’®å¿«é€ŸåŠ å‡åˆ†');
        console.log('- Ctrl+Eï¼šå¯¼å‡ºæ•°æ®ï¼ˆæ”¯æŒExcelï¼‰');
        console.log('- Ctrl+Iï¼šå¯¼å…¥æ•°æ®');
        console.log('- Ctrl+Sï¼šä¿å­˜æ•°æ®');
        console.log('- Ctrl+Fï¼šæœç´¢å­¦ç”Ÿ');
        console.log('- æ•°æ®è‡ªåŠ¨ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°');
        console.log('- æ”¯æŒå¯¼å‡ºä¸ºExcel(CSV)æ ¼å¼ï¼Œå¯ç›´æ¥ç”¨Excelæ‰“å¼€ç¼–è¾‘');

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = init;
    </script>
</body>

</html>